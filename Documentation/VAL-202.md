# VAL-202: Date of Birth Validation

## Issue Summary
**Ticket**: VAL-202 
**Severity**: Critical
**Reporter**: Maria Garcia
**Issue**: Users were able to enter future dates (e.g., 2025) and potentially invalid ages (minors) during sign-up.
**Impact**: Compliance issues (accepting minors) and data integrity problems.

## Root Cause Analysis
The `dateOfBirth` field in the user signup schema was validated only as a generic string:
```typescript
dateOfBirth: z.string(),
```
There were no checks for:
1.  Whether the date is in the future.
2.  Whether the user meets the minimum age requirement (18 years old).

## Resolution
Implemented robust validation using Zod's `.refine()` method in `server/routers/auth.ts`.

### Logic Implemented:
1.  **Future Date Check**: `date > now` results in rejection.
2.  **Age Calculation**: accurately calculates age considering year, month, and day.
3.  **Minimum Age Enforced**: Users must be at least 18 years old.

### Code Change:
```typescript
dateOfBirth: z.string().refine((dob) => {
  const date = new Date(dob);
  const now = new Date();
  if (date > now) return false;
  
  const age = now.getFullYear() - date.getFullYear();
  const monthDiff = now.getMonth() - date.getMonth();
  if (monthDiff < 0 || (monthDiff === 0 && now.getDate() < date.getDate())) {
    return age - 1 >= 18;
  }
  return age >= 18;
}, "You must be at least 18 years old"),
```

### Frontend Validation
Implemented real-time validation in `app/signup/page.tsx` to provide immediate feedback:
-   **Future Date**: Prevents selection/entry of future dates.
-   **Age Check**: Validates that the entered date results in an age >= 18.

## Verification
A reproduction script `tests/validate-date-of-birth.ts` was created to test:
1.  **Future DOB**: Confirmed rejected.
2.  **Minor DOB (< 18)**: Confirmed rejected.

## Preventive Measures
1.  **Standardized Validation**: Use a shared validation library or helper for date checks across the application.
2.  **Testing**: Add comprehensive unit tests for all date-related inputs.
