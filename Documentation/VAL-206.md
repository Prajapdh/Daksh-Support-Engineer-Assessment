# Ticket VAL-206: Card Number Validation

## Issue Summary
**Ticket**: VAL-206 
**Severity**: Critical
**Reporter**: David Brown
**Issue**: The system was accepting invalid card numbers during account funding, leading to failed transactions.
**Impact**: Financial discrepancies and customer frustration.

## Root Cause Analysis
The `fundAccount` procedure in `server/routers/account.ts` accepted any string as a card number for the `fundingSource`:
```typescript
accountNumber: z.string(),
```
There was no validation for:
1.  **Luhn Algorithm**: The standard checksum used to validate credit card numbers.
2.  **Length**: Standard card length checks (typically 13-19 digits).

## Resolution
Implemented robust validation using the Luhn algorithm and length checks.

### Code Changes:
1.  **New Utility**: Created `lib/validationUtils.ts` containing:
    -   `isValidLuhn(cardNumber: string): boolean`
    -   `isValidCardNumber(cardNumber: string): boolean` (checks length 13-19 and Luhn)
2.  **Schema Update**: Updated `server/routers/account.ts` to use `superRefine` on the `fundingSource` object:
    ```typescript
    .superRefine((data, ctx) => {
      if (data.type === 'card') {
        if (!isValidCardNumber(data.accountNumber)) {
          ctx.addIssue({ ... });
        }
      }
    })
    ```

### Frontend Validation
Implemented real-time validation in `components/FundingModal.tsx` using `isValidCardNumber` to reject invalid cards before submission.

## Verification
A reproduction script `tests/verify-valid-credit-card-number.ts` was created to test:
1.  **Invalid Luhn**: Confirmed rejected.
2.  **Cleanup**: Verified that tests clean up created users and accounts/transactions.

## Preventive Measures
1.  **Centralized Validation**: Continue using `lib/validationUtils.ts` for any future card-related inputs.
2.  **PCI Compliance**: Ensure that while we validate card numbers, we are not logging them or storing them in plaintext (masked logging should be used).
