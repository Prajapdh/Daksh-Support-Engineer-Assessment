# Ticket VAL-207: Routing Number Optional

## Issue Summary
**Ticket**: VAL-207
**Severity**: High
**Reporter**: Support Team
**Issue**: Bank transfers were being submitted without routing numbers.
**Impact**: Failed ACH transfers and operational overhead to correct them.

## Root Cause Analysis
The backend schema `server/routers/account.ts` defined `routingNumber` as `z.string().optional()`, allowing requests to omit it even when the funding source was a bank account.

## Resolution
Implemented conditional validation to require routing numbers for bank transfers.

### Code Changes:
1.  **Backend**: Updated `server/routers/account.ts` using `superRefine` to conditionally require `routingNumber`:
    ```typescript
    .superRefine((data, ctx) => {
      if (data.type === 'bank' && !data.routingNumber) {
        ctx.addIssue({ ... message: "Routing number is required..." });
      }
    })
    ```

## Verification
A specialized test script `tests/verify-routing-number-validation.ts` was created to verify:
1.  **Bank Transfer w/o Routing Number**: Rejected with "Routing number is required...".
2.  **Bank Transfer w/ Routing Number**: Accepted.
3.  **Card Transfer**: Accepted without routing number.

## Preventive Measures
1.  **Conditional Validation**: Use `superRefine` or discriminated unions in Zod schemas to enforce requirements that depend on other field values (e.g., if type is X, then Y is required).
2.  **API Contract Review**: Periodically review API schemas to ensure optional fields are truly optional in all contexts.
