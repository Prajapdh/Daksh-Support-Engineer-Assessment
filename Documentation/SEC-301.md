# SEC-301: SSN Storage Fix Report

## Issue Summary
**Ticket**: SEC-301  
**Severity**: Critical  
**Issue**: Social Security Numbers (SSNs) were stored in plaintext in the `users` table of the SQLite database.  
**Impact**: If the database file (`bank.db`) were compromised or leaked, all user SSNs would be exposed, leading to severe privacy violations and compliance failures.

## Root Cause Analysis
The application was directly inserting the raw SSN provided by the user into the database without any encryption or hashing.
- **File**: `server/routers/auth.ts`
- **Code**: `await db.insert(users).values({ ...input })`

## Resolution
We implemented application-level encryption for the SSN field using AES-256-GCM.

### Changes Implemented
1.  **Encryption Utility**: Created `lib/encryption.ts` to handle AES-256-GCM encryption and decryption using a secure 32-byte key.
2.  **Signup Flow**: Modified `server/routers/auth.ts` to encrypt the SSN before inserting it into the database.
3.  **API Security**: Updated `signup` and `login` responses to explicitly exclude the SSN field, ensuring it is never sent back to the client.
4.  **Data Migration**: Created and executed `scripts/migrate-ssns.ts` to scan the database and encrypt any existing plaintext SSNs.

### Validation
- **New Data**: Verified that new user signups enable encryption immediately.
- **Existing Data**: Verified that the migration script successfully encrypted legacy records.
- **API Leakage**: Verified that API responses no longer contain the SSN.

## Preventive Measures
1.  **Strict Typing for Sensitive Data**: Introduce a `Sensitive<T>` type or similar wrapper to strictly control where sensitive data can be used.
2.  **Database Layer Enforcement**: Use database triggers or ORM middleware/hooks (if available in Drizzle) to enforce encryption on specific columns automatically, rather than relying on the router logic.
3.  **Regular Audits**: Schedule automated scans to check for high-entropy patterns (like SSNs) in database dumps or logs.
4.  **Principle of Least Privilege**: Ensure the database file permissions are restricted and the `ENCRYPTION_KEY` is managed via a secure secrets manager in production (not just `.env`).

## Deployment Instructions
1.  **Set Environment Variable**: Ensure `ENCRYPTION_KEY` is set in the production environment variables (use a 32-byte hex string).
2.  **Run Migration**: Execute `npm run migrate:ssn` (or `npx tsx scripts/migrate-ssns.ts`) immediately after deployment to secure existing data.
